
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Planificador de Ruta ¬∑ RD (Single File ¬∑ Offline Guard)</title>
  <link rel="icon" href="data:;base64,=">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
  :root{ --muted:#6b7280; --accent:#2563eb; --ok:#16a34a; --warn:#dc2626; }
  .map{ height: 60vh; width: 100%; border-radius: .5rem; display:flex; align-items:center; justify-content:center; background:#f8fafc; color:#475569; }
  .client-list{ max-height: 30vh; overflow: auto; border: 1px solid #eee; border-radius:.5rem; padding:.5rem; }
  .client-item{ display:flex; align-items:center; gap:.5rem; padding:.35rem .25rem; border-bottom:1px dashed #eee; }
  .client-item:last-child{ border-bottom:none; }
  .client-name{ font-weight:600; }
  .visited-row{ background: #f0fff4; }
  #mappingGrid label{ font-size:.8rem; color:var(--muted); }
  #mappingGrid select{ font-size:.85rem; }
  .offline-note{ font-size:.9rem; color:#334155; }
  </style>
</head>
<body class="bg-light">
  <nav class="navbar navbar-light bg-white border-bottom sticky-top">
    <div class="container-fluid">
      <span class="navbar-brand fw-bold">üß≠ Planificador de Ruta ¬∑ RD</span>
      <div class="d-flex align-items-center gap-2 small text-secondary">
        <span id="statusText">Listo.</span>
        <a class="btn btn-sm btn-outline-primary" href="#" id="btnExportCSV">Exportar CSV</a>
        <a class="btn btn-sm btn-outline-danger" href="#" id="btnClear">Limpiar</a>
      </div>
    </div>
  </nav>

  <div class="container-fluid py-3">
    <div class="row g-3">
      <aside class="col-12 col-lg-4">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title mb-2">Cargar Excel</h5>
            <p class="text-muted small mb-2">
              Requiere conexi√≥n para leer Excel (SheetJS) y mapa (Leaflet). Si est√°s offline, podr√°s probar los <b>datos demo</b>,
              filtros, tabla y visitados, pero el mapa no se cargar√°.
            </p>
            <div class="mb-2">
              <input id="fileInput" type="file" accept=".xlsx,.xls" class="form-control">
            </div>

            <div id="mappingBox" class="border rounded p-2 d-none">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="fw-semibold">Mapeo de columnas</div>
                <button id="btnApplyMapping" class="btn btn-sm btn-primary">Aplicar</button>
              </div>
              <div id="mappingGrid" class="row g-2"></div>
            </div>

            <hr>
            <div class="row g-2">
              <div class="col-12 col-md-6">
                <label class="form-label small">Modo de asignaci√≥n</label>
                <select id="mode" class="form-select form-select-sm">
                  <option value="balance">Balanceado + Cercan√≠a</option>
                  <option value="pure">Pura cercan√≠a</option>
                </select>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label small">L√≠mite visitas/d√≠a</label>
                <select id="limit" class="form-select form-select-sm">
                  <option value="">Sin l√≠mite</option>
                  <option>6</option>
                  <option selected>8</option>
                  <option>10</option>
                  <option>12</option>
                  <option>15</option>
                </select>
              </div>
              <div class="col-12">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="" id="chkSaturday">
                  <label class="form-check-label small" for="chkSaturday">Incluir s√°bado opcional</label>
                </div>
              </div>
              <div class="col-12">
                <button id="btnProcess" class="btn btn-success w-100">Procesar y asignar</button>
              </div>
            </div>

            <hr>
            <h6 class="mb-2">Filtros</h6>
            <div class="row g-2">
              <div class="col-12">
                <input id="txtSearch" class="form-control form-control-sm" placeholder="Buscar cliente..." />
              </div>
              <div class="col-12 col-md-6">
                <select id="filterVendedor" class="form-select form-select-sm">
                  <option value="">(Todos los vendedores)</option>
                </select>
              </div>
              <div class="col-12 col-md-6">
                <select id="filterEmpresa" class="form-select form-select-sm">
                  <option value="">(Todas las empresas)</option>
                </select>
              </div>
              <div class="col-12">
                <select id="filterProvincia" class="form-select form-select-sm">
                  <option value="">(Todas las provincias)</option>
                </select>
              </div>
              <div class="col-12">
                <select id="filterSemana" class="form-select form-select-sm">
                  <option value="">(Todas las semanas)</option>
                  <option value="1">Semana 1</option>
                  <option value="2">Semana 2</option>
                  <option value="3">Semana 3</option>
                  <option value="4">Semana 4</option>
                </select>
              </div>
              <div class="col-12">
                <select id="filterDia" class="form-select form-select-sm">
                  <option value="">(Todos los d√≠as)</option>
                  <option value="Lunes">Lunes</option>
                  <option value="Martes">Martes</option>
                  <option value="Mi√©rcoles">Mi√©rcoles</option>
                  <option value="Jueves">Jueves</option>
                  <option value="Viernes">Viernes</option>
                  <option value="S√°bado">S√°bado</option>
                </select>
              </div>
            </div>

            <hr>
            <h6 class="mb-2">Clientes</h6>
            <div id="listContainer" class="client-list"></div>
          </div>
        </div>
      </aside>

      <main class="col-12 col-lg-8">
        <div class="card shadow-sm mb-3">
          <div class="card-body p-2">
            <div id="map" class="map">
              <div class="offline-note text-center px-3">
                <div class="fw-semibold">Mapa</div>
                <div id="mapNote">Inicializando‚Ä¶</div>
              </div>
            </div>
          </div>
        </div>
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0">Plan (vista actual)</h6>
              <span class="badge bg-secondary" id="badgeCount">0</span>
            </div>
            <div class="table-responsive">
              <table class="table table-sm align-middle" id="tblPlan">
                <thead class="table-light">
                  <tr>
                    <th>Provincia</th><th>D√≠a</th><th>Semana</th><th>Vendedor</th>
                    <th>Gestor</th><th>Empresa</th><th>Raz√≥n Social</th><th>Lat</th><th>Lon</th><th>Visitado</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
  const DAYS_BASE = ["Lunes","Martes","Mi√©rcoles","Jueves","Viernes"];
  const EXPECTED = ["provincia","DIA","SEMANA","vendedor","gestor_servicio","cod_empresa","empresa","razon_social","latitud","longitud"];
  const DEFAULTS = { DIA:"", SEMANA:"", gestor_servicio:"", empresa:"", cod_empresa:"" };

  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const statusText = $("#statusText");
  const listContainer = $("#listContainer");
  const tblBody = $("#tblPlan tbody");
  const badgeCount = $("#badgeCount");
  const filterVendedor = $("#filterVendedor");
  const filterEmpresa = $("#filterEmpresa");
  const filterProvincia = $("#filterProvincia");
  const filterSemana = $("#filterSemana");
  const filterDia = $("#filterDia");
  const txtSearch = $("#txtSearch");
  const limitSel = $("#limit");
  const modeSel = $("#mode");
  const chkSaturday = $("#chkSaturday");
  const mappingBox = $("#mappingBox");
  const mappingGrid = $("#mappingGrid");
  const btnApplyMapping = $("#btnApplyMapping");
  const mapNote = $("#mapNote");

  let RAW_ROWS = [];
  let PLAN_ROWS = [];
  let HEADERS = [];
  let MAPPING = {};
  let map=null, markersLayer=null, mapReady=false;

  function toast(msg){ statusText.textContent = msg; }

  const LS_KEY = "planificador_visitados";
  function loadVisited(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||"{}"); }catch(_){ return {}; } }
  function saveVisited(obj){ localStorage.setItem(LS_KEY, JSON.stringify(obj)); }
  function clientKey(r){ return (r.cod_empresa && String(r.cod_empresa).trim()) || (r.empresa && String(r.empresa).trim()) || r.razon_social; }

  function initMap(){
    if(!(window.L && typeof L.map==="function")){
      mapReady=false;
      mapNote.textContent = "Sin mapa: necesitas conexi√≥n a Internet para cargar Leaflet.";
      return;
    }
    try{
      map = L.map('map').setView([18.7357, -70.1627], 7);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(map);
      markersLayer = L.layerGroup().addTo(map);
      mapReady=true;
      $("#map").style.background="transparent";
      $("#map").style.color="inherit";
      $("#map").innerHTML="";
    }catch(e){
      mapReady=false;
      mapNote.textContent = "No se pudo inicializar el mapa. Revisa la conexi√≥n o abre con un servidor local.";
    }
  }
  function clearMap(){ if(mapReady && markersLayer) markersLayer.clearLayers(); }
  function addMarkers(rows){
    if(!mapReady) return;
    clearMap();
    let bounds = [];
    const visited = loadVisited();
    rows.forEach(r=>{
      if(r.latitud==null || r.longitud==null) return;
      const k = clientKey(r);
      const isVisited = !!visited[k];
      const marker = L.marker([Number(r.latitud), Number(r.longitud)], {opacity: isVisited ? 0.6 : 1});
      const html = `
        <div>
          <div class="fw-bold">${escapeHTML(r.razon_social||"")}</div>
          <div class="small text-muted">${escapeHTML(r.empresa||"")} ¬∑ ${escapeHTML(r.vendedor||"")}</div>
          <div class="small">Provincia: ${escapeHTML(r.provincia||"")}</div>
          <div class="small">Semana ${r.SEMANA||""} ¬∑ ${r.DIA||""}</div>
          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" id="chk_${encodeURIComponent(k)}" ${isVisited?"checked":""}>
            <label class="form-check-label small">Visitado</label>
          </div>
        </div>`;
      marker.bindPopup(html);
      marker.on('popupopen',()=>{
        const el = document.getElementById(`chk_${encodeURIComponent(k)}`);
        if(el){
          el.addEventListener('change', (ev)=> {
            const st = loadVisited();
            if(ev.target.checked){ st[k]=true; } else { delete st[k]; }
            saveVisited(st);
            renderList(currentFiltered());
            renderTable(currentFiltered());
            addMarkers(currentFiltered());
          });
        }
      });
      marker.addTo(markersLayer);
      bounds.push([Number(r.latitud), Number(r.longitud)]);
    });
    if(bounds.length) map.fitBounds(bounds, {padding:[30,30]});
  }

  function escapeHTML(s){ return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }
  function groupBy(arr, key){ const m=new Map(); arr.forEach(it=>{ const k=it[key]; if(!m.has(k)) m.set(k,[]); m.get(k).push(it);}); return m; }
  function uniqSorted(arr){ return Array.from(new Set(arr.filter(Boolean))).sort((a,b)=> String(a).localeCompare(String(b),'es')); }
  function toNum(x){ if(x===null||x===undefined||x==="") return null; const n = Number(String(x).replace(",", ".")); return Number.isFinite(n)?n:null; }

  const ALIASES = {
    "provincia":["provincia","estado","region"],
    "dia":["dia","diavisita","weekday"],
    "semana":["semana","nsemana","sem"],
    "vendedor":["vendedor","seller","rep","asesor","agente","comercial"],
    "gestor_servicio":["gestor_servicio","gestor","supervisor","coordinador","manager"],
    "cod_empresa":["cod empresa","codempresa","codigoempresa","id","codigo"],
    "empresa":["empresa","compania","compa√±ia"],
    "razon_social":["razonsocial","cliente","negocio","nombrecliente"],
    "latitud":["latitud","lat","latitude"],
    "longitud":["longitud","lon","lng","long","longitude"]
  };
  function norm(s){ return String(s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]/g,""); }

  function autoMapping(headers){
    const nh = headers.map(h=>({raw:h, n:norm(h)}));
    const map = {};
    for(const t of EXPECTED){
      let found = nh.find(h=>h.n===norm(t));
      if(!found){
        const als = ALIASES[norm(t)] || [];
        found = nh.find(h=> als.some(a=>h.n===norm(a)));
      }
      if(!found && t==="cod_empresa"){
        found = nh.find(h=> h.n==="empresa" || h.n==="id");
      }
      map[t] = found? found.raw : "(no usar)";
    }
    return map;
  }

  function buildMappingUI(headers){
    mappingGrid.innerHTML = "";
    const opts = ['(no usar)'].concat(headers);
    const current = autoMapping(headers);
    MAPPING = {...current};

    EXPECTED.forEach(target=>{
      const col = document.createElement('div');
      col.className = "col-12 col-md-6";
      col.innerHTML = `
        <label class="form-label">${target}</label>
        <select class="form-select form-select-sm" data-target="${target}">
          ${opts.map(h=>`<option ${current[target]===h?"selected":""}>${h}</option>`).join("")}
        </select>`;
      mappingGrid.appendChild(col);
    });

    mappingBox.classList.remove("d-none");
    mappingBox.scrollIntoView({behavior:"smooth", block:"center"});
  }

  function detectHeaderRow(matrix){
    const must = ["provincia","vendedor","razon","cliente"];
    for(let i=0;i<Math.min(30,matrix.length);i++){
      const row = matrix[i].map(x=> String(x||"").toLowerCase());
      const ok = must.filter(k=> row.some(c=> c.includes(k))).length >= 2;
      if(ok) return i;
    }
    return 0;
  }

  // Excel loader ‚Äì guard if XLSX is missing (offline)
  const fileInput = document.getElementById("fileInput");
  if(fileInput){
    fileInput.addEventListener("change", async (ev)=>{
      if(!(window.XLSX && XLSX.read)){
        toast("Para cargar Excel necesitas conexi√≥n a Internet (SheetJS).");
        return;
      }
      const file = ev.target.files[0];
      if(!file) return;
      const data = await file.arrayBuffer();
      const wb = XLSX.read(data, {type:"array"});
      const wsname = wb.SheetNames[0];
      const ws = wb.Sheets[wsname];
      const matrix = XLSX.utils.sheet_to_json(ws, {header:1, defval:""});
      const hdrIdx = detectHeaderRow(matrix);
      const headers = matrix[hdrIdx].map(String);
      const records = matrix.slice(hdrIdx+1).filter(r=> r.some(x=> String(x).trim()!==""));
      HEADERS = headers;
      RAW_ROWS = records.map(r=>{
        const o = {}; headers.forEach((h,i)=> o[h] = r[i]); return o;
      });
      RAW_ROWS.__source_matrix = records.map(r=> r.slice());
      buildMappingUI(headers);
      toast(`Excel cargado: ${records.length} filas (hoja: ${wsname}).`);
    });
  }

  const btnApplyMapping = document.getElementById("btnApplyMapping");
  if(btnApplyMapping){
    btnApplyMapping.addEventListener("click", ()=>{
      $$('[data-target]').forEach(s=> MAPPING[s.dataset.target] = s.value);
      if(!HEADERS.length) return;
      const matrix = RAW_ROWS.__source_matrix || [];
      const headers = HEADERS;
      const mapped = matrix.map(row=>{
        const obj={};
        EXPECTED.forEach(t=>{
          const src = MAPPING[t];
          const idx = headers.indexOf(src);
          const val = (idx>=0? row[idx] : (DEFAULTS[t]??""));
          obj[t] = val;
        });
        obj.latitud = toNum(obj.latitud);
        obj.longitud = toNum(obj.longitud);
        return obj;
      });
      RAW_ROWS = mapped;
      toast("Mapeo aplicado.");
      refreshAll();
    });
  }

  function balanceWeeks(rows){
    const n=rows.length; const target=Array.from({length:4},(_,i)=>Math.floor(n/4)+(i<(n%4)?1:0)); const counts=[0,0,0,0];
    rows.forEach(r=> counts[r.SEMANA-1]++);
    for(let pass=0;pass<6;pass++){
      let moved=false;
      for(let f=0; f<4; f++){
        for(let t=0; t<4; t++){
          if(counts[f]>target[f] && counts[t]<target[t]){
            const idx = rows.findIndex(r=> r.SEMANA===f+1);
            if(idx>=0){ rows[idx].SEMANA=t+1; counts[f]--; counts[t]++; moved=true; }
          }
        }
      }
      if(!moved) break;
    }
  }

  function euclid(a,b){const dx=a[0]-b[0],dy=a[1]-b[1];return Math.hypot(dx,dy)}
  function mean(points){const s=[0,0];for(const p of points){s[0]+=p[0];s[1]+=p[1];}return [s[0]/points.length,s[1]/points.length]}
  function kmeans(points,k,maxIter=80){
    if(points.length===0) return {labels:[],centers:[]};
    if(k<=1 || points.length<=k){
      const labels = points.map((_,i)=> i%k);
      const centers = Array.from({length:k},(_,i)=> mean(points.filter((_,j)=> labels[j]===i)));
      return {labels,centers};
    }
    const centers=[]; centers.push(points[Math.floor(Math.random()*points.length)]);
    while(centers.length<k){
      const d=points.map(p=> Math.min(...centers.map(c=> euclid(p,c))));
      const sum = d.reduce((a,b)=>a+b,0)||1;
      let r=Math.random()*sum, idx=0;
      for(let i=0;i<d.length;i++){ r-=d[i]; if(r<=0){ idx=i; break; } }
      centers.push(points[idx]);
    }
    let labels=new Array(points.length).fill(0);
    for(let it=0; it<maxIter; it++){
      let changed=false;
      for(let i=0;i<points.length;i++){
        let best=0,bd=Infinity;
        for(let c=0;c<centers.length;c++){ const dd=euclid(points[i],centers[c]); if(dd<bd){bd=dd;best=c;} }
        if(labels[i]!==best){ labels[i]=best; changed=true; }
      }
      const groups=Array.from({length:k},()=>[]);
      for(let i=0;i<points.length;i++) groups[labels[i]].push(points[i]);
      for(let c=0;c<k;c++){ if(groups[c].length>0) centers[c]=mean(groups[c]); }
      if(!changed) break;
    }
    return {labels,centers};
  }

  function assignPlan(data, mode="balance", perDayLimit="", includeSaturday=false){
    const valid = data.map(r=> normalizeRow(r)).filter(r=> r.latitud!=null && r.longitud!=null && r.vendedor);
    const byVend = groupBy(valid, "vendedor");
    const plan = [];
    const DAYS = includeSaturday ? [...DAYS_BASE, "S√°bado"] : DAYS_BASE.slice();

    for(const [vend, items] of byVend){
      const pts = items.map(r=> [Number(r.latitud), Number(r.longitud)]);
      let weekLabels;
      if(items.length>=4){ weekLabels = kmeans(pts,4).labels; } else { weekLabels = items.map((_,i)=> i%4); }
      items.forEach((r,i)=> r.SEMANA = (weekLabels[i]%4) + 1);
      if(mode==="balance") balanceWeeks(items);

      const byWeek = groupBy(items, "SEMANA");
      for(const [week, rows] of byWeek){
        const p = rows.map(r=> [Number(r.latitud), Number(r.longitud)]);
        const k = Math.min(DAYS.length, Math.max(1, rows.length));
        const dlabels = (rows.length>=2)? kmeans(p,k).labels : rows.map(_=>0);

        const meta={};
        for(let i=0;i<rows.length;i++){
          const lab = dlabels[i];
          if(!meta[lab]) meta[lab]={lat:0,lon:0,c:0};
          meta[lab].lat += rows[i].latitud;
          meta[lab].lon += rows[i].longitud;
          meta[lab].c++;
        }
        const ordered = Object.keys(meta).map(Number).sort((a,b)=>{
          const A=meta[a], B=meta[b];
          if((A.lat/A.c)!==(B.lat/B.c)) return (B.lat/B.c)-(A.lat/A.c);
          return (A.lon/A.c)-(B.lon/B.c);
        });
        const mapDay = new Map();
        ordered.forEach((lab,idx)=> mapDay.set(lab, DAYS[idx % DAYS.length]));

        rows.forEach((r,i)=> r.DIA = mapDay.get(dlabels[i]));

        const limit = perDayLimit? Number(perDayLimit) : null;
        if(limit){
          const byDay = groupBy(rows, "DIA");
          const order = DAYS.slice(0, k);
          for(let pass=0; pass<6; pass++){
            let moved=false;
            for(const d of order){
              const list = byDay.get(d)||[];
              if(list.length>limit){
                const extra = list.splice(limit);
                for(const dd of order){
                  const dest = byDay.get(dd)||[];
                  while(extra.length && dest.length<limit){
                    const it = extra.shift(); it.DIA = dd; dest.push(it); moved=true;
                  }
                  byDay.set(dd,dest);
                  if(!extra.length) break;
                }
                while(extra.length){
                  const dd = order[Math.floor(Math.random()*order.length)];
                  const dest = byDay.get(dd)||[];
                  const it = extra.shift(); it.DIA = dd; dest.push(it); byDay.set(dd,dest); moved=true;
                }
              }
            }
            if(!moved) break;
          }
        }

        rows.forEach(r=>{
          plan.push({
            provincia: r.provincia??"",
            DIA: r.DIA??"",
            SEMANA: r.SEMANA??"",
            vendedor: r.vendedor??"",
            gestor_servicio: r.gestor_servicio??"",
            cod_empresa: r.cod_empresa??"",
            empresa: r.empresa??"",
            razon_social: r.razon_social??"",
            latitud: r.latitud??"",
            longitud: r.longitud??""
          });
        });
      }
    }
    return plan.sort((a,b)=> (a.SEMANA-b.SEMANA) ||
      DAYS.indexOf(a.DIA)-DAYS.indexOf(b.DIA) ||
      String(a.vendedor||"").localeCompare(String(b.vendedor||""),'es') ||
      String(a.razon_social||"").localeCompare(String(b.razon_social||""),'es'));
  }

  function normalizeRow(row){
    if(HEADERS && !Object.keys(row).some(k=> EXPECTED.includes(k))){
      const out={};
      EXPECTED.forEach(t=>{
        const src = MAPPING[t];
        out[t] = src && src!=="(no usar)" ? row[src] : (DEFAULTS[t]??"");
      });
      out.latitud = toNum(out.latitud);
      out.longitud = toNum(out.longitud);
      return out;
    } else {
      const out = {...row};
      out.latitud = toNum(out.latitud);
      out.longitud = toNum(out.longitud);
      return out;
    }
  }

  function updateFilters(rows){
    filterVendedor.innerHTML = '<option value="">(Todos los vendedores)</option>' + uniqSorted(rows.map(r=> r.vendedor)).map(v=> `<option>${escapeHTML(v)}</option>`).join("");
    filterEmpresa.innerHTML = '<option value="">(Todas las empresas)</option>' + uniqSorted(rows.map(r=> r.empresa||r.cod_empresa)).map(v=> `<option>${escapeHTML(v)}</option>`).join("");
    filterProvincia.innerHTML = '<option value="">(Todas las provincias)</option>' + uniqSorted(rows.map(r=> r.provincia)).map(v=> `<option>${escapeHTML(v)}</option>`).join("");
  }

  function renderList(rows){
    const visited = loadVisited();
    listContainer.innerHTML = rows.map(r=>{
      const k = clientKey(r);
      const isVisited = !!visited[k];
      return `
        <div class="client-item">
          <input class="form-check-input" type="checkbox" data-act="vis" data-key="${escapeHTML(k)}" ${isVisited?"checked":""}>
          <div class="flex-fill">
            <div class="client-name">${escapeHTML(r.razon_social||"")}</div>
            <div class="small text-muted">${escapeHTML(r.vendedor||"")} ¬∑ ${escapeHTML(r.empresa||"")} ¬∑ S${r.SEMANA||""}/${r.DIA||""}</div>
          </div>
          <button class="btn btn-sm btn-outline-secondary" data-act="go" data-lat="${r.latitud}" data-lon="${r.longitud}">Ir</button>
        </div>`;
    }).join("");

    $$("#listContainer [data-act='go']").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const lat = Number(btn.dataset.lat), lon = Number(btn.dataset.lon);
        if(Number.isFinite(lat) && Number.isFinite(lon) && mapReady){
          map.setView([lat,lon], 15);
        }
      });
    });
    $$("#listContainer [data-act='vis']").forEach(chk=>{
      chk.addEventListener("change", ()=>{
        const st = loadVisited();
        const key = chk.dataset.key;
        if(chk.checked) st[key]=true; else delete st[key];
        saveVisited(st);
        renderTable(currentFiltered());
        addMarkers(currentFiltered());
      });
    });
  }

  function renderTable(rows){
    const visited = loadVisited();
    tblBody.innerHTML = rows.map(r=>{
      const k = clientKey(r);
      const isVisited = !!visited[k];
      const trClass = isVisited? " class='visited-row' " : "";
      return `<tr ${trClass}>
        <td>${escapeHTML(r.provincia||"")}</td>
        <td>${escapeHTML(r.DIA||"")}</td>
        <td>${escapeHTML(r.SEMANA||"")}</td>
        <td>${escapeHTML(r.vendedor||"")}</td>
        <td>${escapeHTML(r.gestor_servicio||"")}</td>
        <td>${escapeHTML(r.empresa||r.cod_empresa||"")}</td>
        <td>${escapeHTML(r.razon_social||"")}</td>
        <td>${r.latitud!=null? Number(r.latitud).toFixed(6):""}</td>
        <td>${r.longitud!=null? Number(r.longitud).toFixed(6):""}</td>
        <td><input type="checkbox" data-act="vis-table" data-key="${escapeHTML(k)}" ${isVisited?"checked":""}></td>
      </tr>`;
    }).join("");
    badgeCount.textContent = rows.length;

    $$("#tblPlan [data-act='vis-table']").forEach(chk=>{
      chk.addEventListener("change", ()=>{
        const st = loadVisited();
        const key = chk.dataset.key;
        if(chk.checked) st[key]=true; else delete st[key];
        saveVisited(st);
        renderList(currentFiltered());
        addMarkers(currentFiltered());
        renderTable(currentFiltered());
      });
    });
  }

  function currentFiltered(){
    const s = txtSearch.value.trim().toLowerCase();
    const v = filterVendedor.value;
    const e = filterEmpresa.value;
    const p = filterProvincia.value;
    const w = filterSemana.value;
    const d = filterDia.value;
    return PLAN_ROWS.filter(r=>{
      if(v && r.vendedor!==v) return false;
      if(e && (r.empresa||r.cod_empresa)!==e) return false;
      if(p && r.provincia!==p) return false;
      if(w && String(r.SEMANA)!==String(w)) return false;
      if(d && r.DIA!==d) return false;
      if(s){
        const hay = [r.razon_social, r.empresa, r.cod_empresa, r.vendedor, r.provincia].some(x=> String(x||"").toLowerCase().includes(s));
        if(!hay) return false;
      }
      return true;
    });
  }

  function refreshAll(){
    updateFilters(RAW_ROWS.map(normalizeRow));
    if(PLAN_ROWS.length){
      const rows = currentFiltered();
      renderList(rows);
      renderTable(rows);
      addMarkers(rows);
    }
  }

  $("#btnProcess").addEventListener("click", ()=>{
    if(!RAW_ROWS.length){ toast("Primero carga un Excel y aplica mapeo si es necesario."); return; }
    const normalized = RAW_ROWS.map(r=> normalizeRow(r));
    const perDayLimit = limitSel.value;
    PLAN_ROWS = assignPlan(normalized, modeSel.value, perDayLimit, chkSaturday.checked);
    updateFilters(PLAN_ROWS);
    const rows = currentFiltered();
    renderList(rows);
    renderTable(rows);
    addMarkers(rows);
    toast(`Plan generado: ${PLAN_ROWS.length} filas.`);
  });

  $("#btnExportCSV").addEventListener("click", ()=>{
    const rows = currentFiltered();
    if(!rows.length){ toast("No hay datos para exportar."); return; }
    const headers = ["provincia","DIA","SEMANA","vendedor","gestor_servicio","empresa","cod_empresa","razon_social","latitud","longitud"];
    const csv = [headers.join(",")].concat(rows.map(r=> headers.map(h=> csvCell(r[h])).join(","))).join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "Plan_Rutas_Filtrado.csv"; a.click();
    URL.revokeObjectURL(url);
  });
  function csvCell(v){ if(v==null) return ""; const s = String(v).replace(/"/g,'""'); if(/[",\n]/.test(s)) return '"' + s + '"'; return s; }

  $("#btnClear").addEventListener("click", ()=>{
    RAW_ROWS=[]; PLAN_ROWS=[]; HEADERS=[]; MAPPING={};
    listContainer.innerHTML=""; tblBody.innerHTML=""; badgeCount.textContent="0";
    mappingGrid.innerHTML=""; mappingBox.classList.add("d-none");
    if(mapReady) clearMap();
    toast("Listo.");
  });

  [filterVendedor, filterEmpresa, filterProvincia, filterSemana, filterDia].forEach(sel=>{
    sel.addEventListener("change", ()=>{
      const rows = currentFiltered();
      renderList(rows);
      renderTable(rows);
      addMarkers(rows);
    });
  });
  txtSearch.addEventListener("input", ()=>{
    const rows = currentFiltered();
    renderList(rows);
    renderTable(rows);
    addMarkers(rows);
  });

  const DEMO = [
    {provincia:"La Altagracia", vendedor:"Ana", gestor_servicio:"Luis", empresa:"FW", cod_empresa:"FW-001", razon_social:"Ferreter√≠a B√°varo", latitud:18.706, longitud:-68.451},
    {provincia:"La Altagracia", vendedor:"Ana", gestor_servicio:"Luis", empresa:"FW", cod_empresa:"FW-002", razon_social:"Total Tools Ver√≥n", latitud:18.567, longitud:-68.396},
    {provincia:"Distrito Nacional", vendedor:"Carlos", gestor_servicio:"Mar√≠a", empresa:"AK", cod_empresa:"AK-010", razon_social:"HogarCenter", latitud:18.469, longitud:-69.891},
    {provincia:"Santiago", vendedor:"Carlos", gestor_servicio:"Mar√≠a", empresa:"AK", cod_empresa:"AK-011", razon_social:"Ferre Norte", latitud:19.468, longitud:-70.699},
    {provincia:"San Crist√≥bal", vendedor:"Ana", gestor_servicio:"Luis", empresa:"FW", cod_empresa:"FW-003", razon_social:"El Tornillo", latitud:18.415, longitud:-70.106},
    {provincia:"La Vega", vendedor:"Pedro", gestor_servicio:"Carmen", empresa:"FW", cod_empresa:"FW-004", razon_social:"Construvega", latitud:19.222, longitud:-70.529},
    {provincia:"Puerto Plata", vendedor:"Pedro", gestor_servicio:"Carmen", empresa:"AK", cod_empresa:"AK-012", razon_social:"Atl√°ntico Tools", latitud:19.794, longitud:-70.694},
  ];

  window.addEventListener("DOMContentLoaded", ()=>{
    initMap();
    PLAN_ROWS = assignPlan(DEMO, "balance", "8", false);
    updateFilters(PLAN_ROWS);
    const rows = currentFiltered();
    renderList(rows); renderTable(rows); addMarkers(rows);
  });
  </script>
</body>
</html>
