
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Planificador de Ruta ¬∑ RD (resiliente)</title>
  <link rel="icon" href="data:;base64,=">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{ background:#f6f7fb; }
    .app-shell{ padding: 12px; }
    #map, .leaflet-container{ min-height:60vh !important; width:100%; border-radius:.75rem; background:#f8fafc; display:flex; align-items:center; justify-content:center; color:#475569; }
    .client-list{ max-height: 30vh; overflow:auto; border:1px solid #eee; border-radius:.5rem; padding:.5rem; background:white; }
    .visited-row{ background:#f0fff4; }
    .sticky-th{ position:sticky; top:0; z-index:1; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg bg-white shadow-sm sticky-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="#"><b>üß≠ Planificador</b> de Ruta ¬∑ RD</a>
      <div class="d-flex gap-2 small">
        <span id="statusText" class="text-secondary">Listo.</span>
        <a class="btn btn-sm btn-outline-primary" id="btnExportCSV">Exportar CSV</a>
        <a class="btn btn-sm btn-outline-danger" id="btnClear">Limpiar</a>
      </div>
    </div>
  </nav>

  <div class="container-fluid app-shell">
    <div class="row g-3">
      <aside class="col-12 col-lg-4">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="mb-2">Cargar datos (Google Sheets CSV o Excel/CSV)</div>
            <div class="input-group mb-2">
              <span class="input-group-text">Sheets CSV</span>
              <input id="sheetsUrl" class="form-control" placeholder="https://docs.google.com/.../pub?output=csv">
              <button class="btn btn-outline-primary" id="btnLoadSheets">Cargar</button>
            </div>
            <div class="input-group mb-2">
              <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" class="form-control">
            </div>
            <div id="mappingBox" class="border rounded p-2 d-none">
              <div class="fw-semibold mb-2">Mapeo</div>
              <div id="mappingGrid" class="row g-2"></div>
              <button class="btn btn-sm btn-secondary mt-2" id="btnApplyMapping">Aplicar</button>
            </div>
            <hr>
            <div class="row g-2">
              <div class="col-6">
                <label class="form-label small">Modo</label>
                <select id="mode" class="form-select form-select-sm">
                  <option value="balance">Balanceado + Cercan√≠a</option>
                  <option value="pure">Pura cercan√≠a</option>
                </select>
              </div>
              <div class="col-6">
                <label class="form-label small">L√≠mite/d√≠a</label>
                <select id="limit" class="form-select form-select-sm">
                  <option value="">Sin l√≠mite</option><option>6</option><option selected>8</option><option>10</option><option>12</option>
                </select>
              </div>
              <div class="col-12">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="chkSaturday">
                  <label class="form-check-label small" for="chkSaturday">Incluir s√°bado</label>
                </div>
              </div>
              <div class="col-12">
                <button id="btnProcess" class="btn btn-success w-100">Procesar y asignar</button>
              </div>
            </div>
            <hr>
            <div class="row g-2">
              <div class="col-12"><input id="txtSearch" class="form-control form-control-sm" placeholder="Buscar..."></div>
              <div class="col-6"><select id="filterVendedor" class="form-select form-select-sm"><option value="">(Vendedores)</option></select></div>
              <div class="col-6"><select id="filterEmpresa" class="form-select form-select-sm"><option value="">(Empresas)</option></select></div>
              <div class="col-12"><select id="filterProvincia" class="form-select form-select-sm"><option value="">(Provincias)</option></select></div>
              <div class="col-12"><select id="filterSemana" class="form-select form-select-sm"><option value="">(Semanas)</option><option>1</option><option>2</option><option>3</option><option>4</option></select></div>
              <div class="col-12"><select id="filterDia" class="form-select form-select-sm"><option value="">(D√≠as)</option><option>Lunes</option><option>Martes</option><option>Mi√©rcoles</option><option>Jueves</option><option>Viernes</option><option>S√°bado</option></select></div>
            </div>
            <hr>
            <div class="small text-muted">Tip: si el mapa no carga, esta versi√≥n cambia autom√°ticamente de servidor de mapas.</div>
          </div>
        </div>
      </aside>
      <main class="col-12 col-lg-8">
        <div class="card shadow-sm mb-3"><div class="card-body p-2"><div id="map"><div id="mapNote">Mapa inicializando‚Ä¶</div></div></div></div>
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="fw-bold">Plan (vista actual)</div>
              <span class="badge bg-secondary" id="badgeCount">0</span>
            </div>
            <div class="table-responsive">
              <table class="table table-sm align-middle" id="tblPlan">
                <thead class="table-light sticky-th">
                  <tr><th>Provincia</th><th>D√≠a</th><th>Semana</th><th>Vendedor</th><th>Gestor</th><th>Empresa</th><th>Raz√≥n Social</th><th>Lat</th><th>Lon</th><th>Visitado</th></tr>
                </thead><tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script>
  async function loadScriptWithFallbacks(urls){
    for(const url of urls){
      try{
        await new Promise((res, rej)=>{
          const s = document.createElement('script'); s.src=url; s.async=true;
          s.onload=()=>res(); s.onerror=()=>rej();
          document.head.appendChild(s);
        });
        return true;
      }catch(e){}
    } return false;
  }
  async function ensureLeaflet(){
    if(window.L && L.map) return true;
    return await loadScriptWithFallbacks([
      "https://unpkg.com/leaflet@1.9.4/dist/leaflet.js",
      "https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js",
      "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"
    ]);
  }
  </script>

  <script>
  const $ = s=>document.querySelector(s), $$ = s=>Array.from(document.querySelectorAll(s));
  const statusText=$("#statusText"), tblBody=$("#tblPlan tbody"), badgeCount=$("#badgeCount");
  const filterVendedor=$("#filterVendedor"), filterEmpresa=$("#filterEmpresa"), filterProvincia=$("#filterProvincia"), filterSemana=$("#filterSemana"), filterDia=$("#filterDia"), txtSearch=$("#txtSearch");
  const mappingGrid=$("#mappingGrid"), mappingBox=$("#mappingBox");

  const EXPECTED=["provincia","DIA","SEMANA","vendedor","gestor_servicio","cod_empresa","empresa","razon_social","latitud","longitud"];
  const DEFAULTS={DIA:"",SEMANA:"",gestor_servicio:"",empresa:"",cod_empresa:""};
  let RAW_ROWS=[], HEADERS=[], MAPPING={}, PLAN_ROWS=[];
  let map=null, markers=null, mapReady=false, providerIndex=0;
  const providers=[
    {name:"OSM", url:'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'},
    {name:"OSM HOT", url:'https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png'},
    {name:"Carto Light", url:'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png'},
    {name:"Carto Voyager", url:'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png'},
    {name:"Stadia", url:'https://tiles.stadiamaps.com/tiles/alidade_smooth/{z}/{x}/{y}{r}.png'},
    {name:"Esri Street", url:'https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}'}
  ];

  function toast(m){ statusText.textContent=m; }
  function parseCoord(v){ if(v==null||v==="") return NaN; let s=String(v).trim().replace(/[^0-9,\.\-]/g,''); if(s.includes('.')&&s.includes(',')) s=s.replace(/,/g,''); else s=s.replace(',', '.'); const n=parseFloat(s); return Number.isFinite(n)?n:NaN; }
  function toNum(x){ const n=parseCoord(x); return Number.isFinite(n)?n:null; }
  function escapeHTML(s){return String(s||"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));}

  async function initMap(){
    const ok = await ensureLeaflet();
    if(!ok){ $("#mapNote").textContent="No se pudo cargar Leaflet."; return; }
    if(map) return;
    map=L.map('map').setView([18.7357,-70.1627],8);
    markers=L.layerGroup().addTo(map);
    attachProvider(providerIndex);
    $("#map").innerHTML="";
    setTimeout(()=> map.invalidateSize(true),150);
  }
  function attachProvider(idx){
    if(map._tileLayer) map.removeLayer(map._tileLayer);
    const prov = providers[idx%providers.length];
    const tl = L.tileLayer(prov.url, {maxZoom:19, attribution:'&copy; OpenStreetMap & contributors'});
    map._tileLayer=tl.addTo(map);
    tl.on('tileerror', ()=>{ // cambia autom√°ticamente si hay error de tiles
      providerIndex++; attachProvider(providerIndex);
      toast("Cambiando servidor de mapas a: "+providers[(providerIndex)%providers.length].name);
    });
    const DefaultIcon = L.icon({
      iconUrl:'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/images/marker-icon.png',
      iconRetinaUrl:'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/images/marker-icon-2x.png',
      shadowUrl:'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/images/marker-shadow.png',
      iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41]
    });
    L.Marker.prototype.options.icon = DefaultIcon;
  }
  function renderPins(rows){
    if(!map) return;
    markers.clearLayers();
    const bounds=[];
    rows.forEach(r=>{
      const lat=parseCoord(r.latitud), lon=parseCoord(r.longitud);
      if(!Number.isFinite(lat)||!Number.isFinite(lon)) return;
      L.marker([lat,lon]).addTo(markers)
       .bindPopup(`<b>${escapeHTML(r.razon_social||"")}</b><br>${escapeHTML(r.empresa||"")} ‚Ä¢ ${escapeHTML(r.vendedor||"")}<br>S${r.SEMANA||""} ¬∑ ${escapeHTML(r.DIA||"")}`);
      bounds.push([lat,lon]);
    });
    if(bounds.length) map.fitBounds(bounds,{padding:[20,20]});
  }

  function uniqSorted(a){ return [...new Set(a.filter(Boolean))].sort((x,y)=> String(x).localeCompare(String(y),'es',{numeric:true})); }
  function updateFilters(rows){
    filterVendedor.innerHTML='<option value="">(Vendedores)</option>'+uniqSorted(rows.map(r=>r.vendedor)).map(v=>`<option>${escapeHTML(v)}</option>`).join('');
    filterEmpresa.innerHTML='<option value="">(Empresas)</option>'+uniqSorted(rows.map(r=>r.empresa||r.cod_empresa)).map(v=>`<option>${escapeHTML(v)}</option>`).join('');
    filterProvincia.innerHTML='<option value="">(Provincias)</option>'+uniqSorted(rows.map(r=>r.provincia)).map(v=>`<option>${escapeHTML(v)}</option>`).join('');
  }
  function renderTable(rows){
    tblBody.innerHTML = rows.map(r=>`<tr>
      <td>${escapeHTML(r.provincia||"")}</td><td>${escapeHTML(r.DIA||"")}</td><td>${escapeHTML(r.SEMANA||"")}</td>
      <td>${escapeHTML(r.vendedor||"")}</td><td>${escapeHTML(r.gestor_servicio||"")}</td>
      <td>${escapeHTML(r.empresa||r.cod_empresa||"")}</td><td>${escapeHTML(r.razon_social||"")}</td>
      <td>${r.latitud?Number(parseCoord(r.latitud)).toFixed(6):""}</td><td>${r.longitud?Number(parseCoord(r.longitud)).toFixed(6):""}</td>
      <td></td></tr>`).join('');
    badgeCount.textContent = rows.length;
  }
  function currentFiltered(){
    const s=txtSearch.value.trim().toLowerCase(), v=filterVendedor.value, e=filterEmpresa.value, p=filterProvincia.value, w=filterSemana.value, d=filterDia.value;
    return PLAN_ROWS.filter(r=>{
      if(v && r.vendedor!==v) return false;
      if(e && (r.empresa||r.cod_empresa)!==e) return false;
      if(p && r.provincia!==p) return false;
      if(w && String(r.SEMANA)!==String(w)) return false;
      if(d && r.DIA!==d) return false;
      if(s && ![r.razon_social,r.empresa,r.cod_empresa,r.vendedor,r.provincia].some(x=> String(x||"").toLowerCase().includes(s))) return false;
      return true;
    });
  }

  // Mapping
  const ALIASES={provincia:["provincia","estado"], DIA:["dia","weekday"], SEMANA:["semana","sem"], vendedor:["vendedor","rep","asesor","agente"], gestor_servicio:["gestor","gestor_servicio"], cod_empresa:["cod empresa","cod_empresa","id","codigo"], empresa:["empresa","compania"], razon_social:["razonsocial","cliente","negocio"], latitud:["latitud","lat"], longitud:["longitud","lon","lng","long"]};
  function norm(s){ return String(s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]/g,""); }
  function autoMapping(headers){
    const nh=headers.map(h=>({raw:h, n:norm(h)})); const map={};
    EXPECTED.forEach(t=>{
      let hit=nh.find(h=>h.n===norm(t));
      if(!hit){ const als=ALIASES[t]||[]; hit=nh.find(h=> als.some(a=>h.n===norm(a))); }
      if(!hit && t==="cod_empresa"){ hit=nh.find(h=> h.n==="empresa"||h.n==="id"); }
      map[t]=hit? hit.raw : "(no usar)";
    });
    return map;
  }
  function buildMappingUI(headers){
    mappingGrid.innerHTML="";
    const opts=['(no usar)'].concat(headers);
    MAPPING=autoMapping(headers);
    EXPECTED.forEach(t=>{
      const d=document.createElement('div'); d.className="col-12 col-md-6";
      d.innerHTML=`<label class="form-label">${t}</label>
        <select class="form-select form-select-sm" data-target="${t}">
          ${opts.map(h=>`<option ${MAPPING[t]===h?"selected":""}>${h}</option>`).join("")}
        </select>`;
      mappingGrid.appendChild(d);
    });
    mappingBox.classList.remove("d-none");
  }
  function normalizeFromMapping(){
    if(!HEADERS.length||!RAW_ROWS.length){ toast("Carga datos y aplica mapeo."); return []; }
    return RAW_ROWS.map(row=>{
      const out={}; EXPECTED.forEach(t=>{ const src=MAPPING[t]; out[t]= src && src!=="(no usar)" ? row[src] : (DEFAULTS[t]||""); });
      out.latitud=toNum(out.latitud); out.longitud=toNum(out.longitud);
      return out;
    });
  }

  // Loaders
  function parseCSV(text){
    const rows=[]; let cur=[], field="", inQ=false;
    for(let i=0;i<text.length;i++){ const c=text[i], n=text[i+1];
      if(inQ){ if(c=='"' && n=='"'){ field+='"'; i++; } else if(c=='"'){ inQ=false; } else field+=c; }
      else { if(c==','){ cur.push(field); field=""; } else if(c=='\n' || c=='\r'){ if(c=='\r' && n=='\n') i++; cur.push(field); field=""; rows.push(cur); cur=[]; } else if(c=='"'){ inQ=true; } else field+=c; }
    }
    if(field.length>0 || cur.length>0){ cur.push(field); rows.push(cur); }
    return rows;
  }
  async function loadFromSheets(url){
    await initMap();
    toast("Cargando Google Sheets...");
    const resp = await fetch(url, {cache:'no-store'}); const text = await resp.text();
    const matrix=parseCSV(text); HEADERS=matrix[0]; const records=matrix.slice(1).filter(r=> r.some(x=> String(x).trim()!==""));
    RAW_ROWS = records.map(r=>{ const o={}; HEADERS.forEach((h,i)=> o[h]=r[i]); return o; });
    buildMappingUI(HEADERS); toast(`Hoja cargada: ${records.length} filas.`);
  }
  async function loadLocalFile(file){
    await initMap();
    const name=file.name.toLowerCase();
    if(name.endsWith(".csv")){
      const text=await file.text(); const matrix=parseCSV(text); HEADERS=matrix[0];
      const records=matrix.slice(1).filter(r=> r.some(x=> String(x).trim()!==""));
      RAW_ROWS=records.map(r=>{ const o={}; HEADERS.forEach((h,i)=> o[h]=r[i]); return o; });
      buildMappingUI(HEADERS); toast(`CSV cargado: ${records.length} filas.`); return;
    }
    if(!(window.XLSX && XLSX.read)){
      const ok = await loadScriptWithFallbacks([
        "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js",
        "https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js",
        "https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"
      ]);
      if(!ok){ toast("No se pudo cargar SheetJS."); return; }
    }
    const data=await file.arrayBuffer();
    const wb=XLSX.read(data,{type:"array"}); const wsname=wb.SheetNames[0]; const ws=wb.Sheets[wsname];
    const matrix=XLSX.utils.sheet_to_json(ws,{header:1,defval:""}); HEADERS=matrix[0].map(String);
    const records=matrix.slice(1).filter(r=> r.some(x=> String(x).trim()!==""));
    RAW_ROWS=records.map(r=>{ const o={}; HEADERS.forEach((h,i)=> o[h]=r[i]); return o; });
    buildMappingUI(HEADERS); toast(`Excel cargado: ${records.length} filas (${wsname}).`);
  }

  // Assign
  function kmeans(points,k,maxIter=80){
    function euclid(a,b){const dx=a[0]-b[0],dy=a[1]-b[1];return Math.hypot(dx,dy)}
    function mean(ps){const s=[0,0];for(const p of ps){s[0]+=p[0];s[1]+=p[1];}return [s[0]/ps.length,s[1]/ps.length]}
    if(points.length===0) return {labels:[],centers:[]};
    if(k<=1 || points.length<=k){ const labels=points.map((_,i)=> i%k); const centers=Array.from({length:k},(_,i)=> mean(points.filter((_,j)=> labels[j]===i))); return {labels,centers}; }
    const centers=[]; centers.push(points[Math.floor(Math.random()*points.length)]);
    while(centers.length<k){ const d=points.map(p=> Math.min(...centers.map(c=> euclid(p,c)))); const sum=d.reduce((a,b)=>a+b,0)||1; let r=Math.random()*sum, idx=0; for(let i=0;i<d.length;i++){ r-=d[i]; if(r<=0){ idx=i; break; } } centers.push(points[idx]); }
    let labels=new Array(points.length).fill(0);
    for(let it=0; it<maxIter; it++){ let changed=false;
      for(let i=0;i<points.length;i++){ let best=0,bd=Infinity; for(let c=0;c<centers.length;c++){ const dd=euclid(points[i],centers[c]); if(dd<bd){bd=dd;best=c;} } if(labels[i]!==best){ labels[i]=best; changed=true; } }
      const groups=Array.from({length:k},()=>[]);
      for(let i=0;i<points.length;i++) groups[labels[i]].push(points[i]);
      for(let c=0;c<k;c++){ if(groups[c].length>0) centers[c]=mean(groups[c]); }
      if(!changed) break;
    }
    return {labels,centers};
  }
  function balanceWeeks(rows){
    const n=rows.length; const target=Array.from({length:4},(_,i)=>Math.floor(n/4)+(i<(n%4)?1:0)); const counts=[0,0,0,0];
    rows.forEach(r=> counts[r.SEMANA-1]++);
    for(let pass=0;pass<6;pass++){ let moved=false;
      for(let f=0; f<4; f++){ for(let t=0; t<4; t++){ if(counts[f]>target[f] && counts[t]<target[t]){
        const idx=rows.findIndex(r=> r.SEMANA===f+1); if(idx>=0){ rows[idx].SEMANA=t+1; counts[f]--; counts[t]++; moved=true; } } } }
      if(!moved) break;
    }
  }
  function assignPlan(data, mode="balance", perDayLimit="", includeSaturday=false){
    const DAYS = includeSaturday? ["Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado"] : ["Lunes","Martes","Mi√©rcoles","Jueves","Viernes"];
    const valid=data.map(r=> ({...r, latitud:toNum(r.latitud), longitud:toNum(r.longitud)})).filter(r=> r.latitud!=null && r.longitud!=null && r.vendedor);
    const byVend=new Map(); valid.forEach(r=>{ const k=r.vendedor; if(!byVend.has(k)) byVend.set(k,[]); byVend.get(k).push(r); });
    const plan=[];
    for(const [vend, items] of byVend){
      const pts=items.map(r=>[Number(r.latitud),Number(r.longitud)]);
      const wl = (items.length>=4)? kmeans(pts,4).labels : items.map((_,i)=> i%4);
      items.forEach((r,i)=> r.SEMANA = (wl[i]%4)+1);
      if(mode==="balance") balanceWeeks(items);
      const byWeek=new Map(); items.forEach(r=>{ const k=r.SEMANA; if(!byWeek.has(k)) byWeek.set(k,[]); byWeek.get(k).push(r); });
      for(const [w,rows] of byWeek){
        const p=rows.map(r=>[Number(r.latitud),Number(r.longitud)]);
        const k=Math.min(DAYS.length, Math.max(1, rows.length));
        const dl = (rows.length>=2)? kmeans(p,k).labels : rows.map(_=>0);
        const meta={};
        for(let i=0;i<rows.length;i++){ const lab=dl[i]; if(!meta[lab]) meta[lab]={lat:0,lon:0,c:0}; meta[lab].lat+=rows[i].latitud; meta[lab].lon+=rows[i].longitud; meta[lab].c++; }
        const ordered = Object.keys(meta).map(Number).sort((a,b)=>{
          const A=meta[a],B=meta[b]; if((A.lat/A.c)!==(B.lat/B.c)) return (B.lat/B.c)-(A.lat/A.c); return (A.lon/A.c)-(B.lon/B.c);
        });
        const mapDay=new Map(); ordered.forEach((lab,idx)=> mapDay.set(lab, DAYS[idx%DAYS.length]));
        rows.forEach((r,i)=> r.DIA = mapDay.get(dl[i]));
        const limit = perDayLimit? Number(perDayLimit): null;
        if(limit){ const byDay=new Map(); rows.forEach(r=>{ const k=r.DIA; if(!byDay.has(k)) byDay.set(k,[]); byDay.get(k).push(r); });
          const order=DAYS.slice(0,k);
          for(let pass=0; pass<6; pass++){ let moved=false;
            for(const d of order){ const list=byDay.get(d)||[];
              if(list.length>limit){ const extra=list.splice(limit);
                for(const dd of order){ const dest=byDay.get(dd)||[]; while(extra.length && dest.length<limit){ const it=extra.shift(); it.DIA=dd; dest.push(it); moved=true; } byDay.set(dd,dest); if(!extra.length) break; }
                while(extra.length){ const dd=order[Math.floor(Math.random()*order.length)]; const dest=byDay.get(dd)||[]; const it=extra.shift(); it.DIA=dd; dest.push(it); byDay.set(dd,dest); moved=true; }
              }
            }
            if(!moved) break;
          }
        }
        rows.forEach(r=> plan.push({...r}));
      }
    }
    return plan.sort((a,b)=> (a.SEMANA-b.SEMANA) || DAYS.indexOf(a.DIA)-DAYS.indexOf(b.DIA) || String(a.vendedor||"").localeCompare(String(b.vendedor||""),'es') || String(a.razon_social||"").localeCompare(String(b.razon_social||""),'es'));
  }

  // Actions
  document.getElementById("btnLoadSheets").onclick = ()=>{
    const url = document.getElementById("sheetsUrl").value.trim();
    if(!url) return toast("Pega URL CSV de Google Sheets."); loadFromSheets(url);
  };
  document.getElementById("fileInput").addEventListener("change", async ev=>{
    const f=ev.target.files[0]; if(!f) return; await loadLocalFile(f);
  });
  document.getElementById("btnApplyMapping").onclick = ()=>{
    $$("[data-target]").forEach(s=> MAPPING[s.dataset.target]=s.value); toast("Mapeo aplicado.");
  };
  document.getElementById("btnExportCSV").onclick = ()=>{
    const rows=currentFiltered(); if(!rows.length) return toast("No hay datos.");
    const headers=["provincia","DIA","SEMANA","vendedor","gestor_servicio","empresa","cod_empresa","razon_social","latitud","longitud"];
    const csv=[headers.join(",")].concat(rows.map(r=> headers.map(h=>{const v=r[h]; if(v==null) return ""; const s=String(v).replace(/"/g,'""'); return /["\n,]/.test(s)?'"'+s+'"':s;}).join(","))).join("\n");
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="Plan_Rutas_Filtrado.csv"; a.click(); URL.revokeObjectURL(url);
  };
  document.getElementById("btnClear").onclick = ()=>{
    RAW_ROWS=[]; HEADERS=[]; MAPPING={}; PLAN_ROWS=[];
    mappingGrid.innerHTML=""; mappingBox.classList.add("d-none"); tblBody.innerHTML=""; badgeCount.textContent="0";
    if(markers) markers.clearLayers(); toast("Listo.");
  };

  [filterVendedor, filterEmpresa, filterProvincia, filterSemana, filterDia].forEach(el=> el.addEventListener("change", ()=>{
    const rows=currentFiltered(); renderTable(rows); renderPins(rows);
  }));
  txtSearch.addEventListener("input", ()=>{ const rows=currentFiltered(); renderTable(rows); renderPins(rows); });

  document.getElementById("btnProcess").onclick = ()=>{
    const base = normalizeFromMapping(); if(!base.length) return toast("Carga datos y aplica mapeo.");
    PLAN_ROWS = assignPlan(base, document.getElementById("mode").value, document.getElementById("limit").value, document.getElementById("chkSaturday").checked);
    updateFilters(PLAN_ROWS); const rows=currentFiltered(); renderTable(rows); renderPins(rows); toast(`Plan generado: ${PLAN_ROWS.length} filas.`);
  };

  document.addEventListener("DOMContentLoaded", ()=>{ initMap(); });
  </script>
</body>
</html>
