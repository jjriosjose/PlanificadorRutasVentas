<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Planificador de Ruta · RD — v1.1.2</title>

<!-- Leaflet & plugins -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<!-- XLSX & CSV -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<!-- Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lucide-static@0.469.0/font/lucide.css">

<style>
:root{
  --bg:#f7f8fb;
  --panel:#ffffff;
  --text:#1f2937;
  --muted:#6b7280;
  --brand:#0ea5e9;
  --ok:#16a34a;
  --warn:#f59e0b;
  --danger:#ef4444;
  --shadow: 0 10px 20px rgba(0,0,0,.06);
  --radius:16px;
  --radius-sm:10px;
  --gap:14px;
  --accent:#2563eb;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,Helvetica,sans-serif;
  color:var(--text);
  background:var(--bg);
}
header{
  position:sticky; top:0; z-index:40;
  backdrop-filter:saturate(1.2) blur(8px);
  background:rgba(247,248,251,.75);
  border-bottom:1px solid #e5e7eb;
}
.header-wrap{
  max-width:1400px; margin:0 auto; padding:12px 18px;
  display:flex; align-items:center; gap:12px; justify-content:space-between;
}
.brand{
  display:flex; align-items:center; gap:12px;
  font-weight:700; letter-spacing:.2px;
}
.badge{background:#e0f2fe;color:#0369a1;padding:4px 8px;border-radius:999px;font-size:12px;}
.version{background:#ecfeff;color:#155e75;padding:4px 8px;border-radius:999px;font-size:12px;}

.container{
  max-width:1400px; margin:18px auto; padding:0 18px;
  display:grid; grid-template-columns: 390px 1fr;
  gap:18px;
}
@media (max-width: 1200px){
  .container{ grid-template-columns: 1fr; }
}

.panel{
  background:var(--panel);
  border:1px solid #e5e7eb; border-radius:var(--radius);
  box-shadow:var(--shadow);
}
.panel h3{margin:0; padding:14px 16px; border-bottom:1px solid #e5e7eb; font-size:16px}
.section{padding:14px 16px; border-top:1px dashed #eef2f7}
.row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
select,input[type="text"],input[type="number"]{
  width:100%; padding:10px 12px; border-radius:10px; border:1px solid #e5e7eb; background:#fff;
  font-size:14px; color:var(--text);
}
button{
  border:0; padding:10px 14px; border-radius:12px; font-weight:600; cursor:pointer;
}
.btn{background:#0ea5e9;color:#fff}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn-ghost{background:#eef2f7;color:#0f172a}
.btn-green{background:var(--ok); color:#fff}
.btn-red{background:var(--danger); color:#fff}

.map-wrap{
  display:grid; grid-template-rows: 52px 1fr minmax(340px, 45vh); gap:12px; height:calc(100vh - 120px);
}
.toolbar{
  display:flex; gap:10px; align-items:center; padding:8px 10px;
}
.toolbar .spacer{flex:1}
#map{width:100%; height:100%; border-radius:var(--radius); border:1px solid #e5e7eb}
.table{
  height:100%; overflow:auto; border:1px solid #e5e7eb; border-radius:var(--radius);
}
table{width:100%; border-collapse:separate; border-spacing:0}
th,td{font-size:13px; padding:10px 8px; border-bottom:1px solid #eef2f7}
th{position:sticky; top:0; background:#f8fafc; z-index:2; text-align:left}
tfoot td{background:#fafafa; position:sticky; bottom:0}
.chips{display:flex; gap:6px; flex-wrap:wrap}
.chips .chip{background:#eef2ff;color:#3730a3;padding:4px 8px;font-size:12px;border-radius:999px}

.small{font-size:12px; color:var(--muted)}
hr.sep{border:0;border-top:1px dashed #e5e7eb;margin:12px 0}
.checkbox{display:flex; gap:8px; align-items:center}
.note{background:#f8fafc;border:1px dashed #e2e8f0;padding:10px;border-radius:12px;font-size:12px;color:#475569}

footer{max-width:1400px;margin:16px auto 32px;padding:0 18px;color:#64748b;font-size:12px}
kbd{background:#e2e8f0;border-radius:6px;padding:2px 6px}
.badge-info{background:#ecfeff;color:#155e75;padding:3px 6px;border-radius:999px;font-size:11px;margin-left:6px}
</style>
</head>
<body>
<header>
  <div class="header-wrap">
    <div class="brand">
      <span class="lucide lucide-map-pin"></span>
      <span>Planificador de Ruta · RD</span>
      <span class="badge">Mapa + Plan</span>
    </div>
    <div class="chips">
      <span class="chip">Semanas 1–4</span>
      <span class="chip">Lun–Vie, Sáb opcional</span>
      <span class="version">v1.1.2</span>
    </div>
  </div>
</header>

<main class="container">
  <!-- Sidebar -->
  <aside class="panel" id="sidebar">
    <h3>Cargar datos (Google Sheets CSV o Excel/CSV)</h3>
    <div class="section">
      <div class="row" style="grid-template-columns:1fr auto">
        <input id="gsheetUrl" type="text" placeholder="https://docs.google.com/.../pub?output=csv">
        <button class="btn" id="btnLoadGSheet">Cargar</button>
      </div>
      <div class="row" style="margin-top:10px">
        <label>Seleccionar archivo</label>
        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" />
      </div>
      <div class="note" style="margin-top:10px">
        Acepta columnas típicas: <b>provincia, gestor_servicio, vendedor, empresa, razon_social, latitud, longitud</b>.
        Puedes mapear nombres distintos en la sección siguiente.
      </div>
    </div>

    <h3>Mapeo</h3>
    <div class="section" id="mapping">
      <div class="row">
        <div><label>provincia</label><select id="map-provincia"></select></div>
        <div><label>DÍA</label><select id="map-dia"></select></div>
        <div><label>SEMANA</label><select id="map-semana"></select></div>
        <div><label>vendedor</label><select id="map-vendedor"></select></div>
        <div><label>gestor_servicio</label><select id="map-gestor"></select></div>
        <div><label>cod_empresa</label><select id="map-codempresa"></select></div>
        <div><label>empresa</label><select id="map-empresa"></select></div>
        <div><label>razon_social</label><select id="map-razon"></select></div>
        <div><label>latitud</label><select id="map-lat"></select></div>
        <div><label>longitud</label><select id="map-lon"></select></div>
      </div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn-ghost" id="btnAutoMap">Autodetectar</button>
        <button class="btn" id="btnApplyMap">Aplicar</button>
      </div>
    </div>

    <h3>Asignación & preferencias</h3>
    <div class="section">
      <div class="row">
        <div>
          <label>Modo</label>
          <select id="mode">
            <option>Balanceado + Cercanía</option>
            <option>Sólo cercanía</option>
            <option>Balanceado</option>
          </select>
        </div>
        <div>
          <label>Límite/día</label>
          <input id="limitPerDay" type="number" min="1" value="8"/>
        </div>
      </div>
      <div class="checkbox" style="margin-top:10px">
        <input type="checkbox" id="chkSabado" />
        <label for="chkSabado">Incluir sábado</label>
      </div>
      <div style="display:flex; gap:8px; margin-top:12px">
        <button class="btn-green" id="btnProcesar">Procesar y asignar</button>
        <button class="btn-red" id="btnLimpiar">Limpiar</button>
      </div>
      <hr class="sep"/>
      <div class="row">
        <div>
          <label>Buscar…</label>
          <input type="text" id="searchBox" placeholder="Razón social / vendedor / gestor / empresa" />
        </div>
        <div>
          <label>Centro inicial del mapa</label>
          <input type="text" id="mapCenter" placeholder="18.735693,-70.162651 (RD)" value="18.735693,-70.162651"/>
        </div>
      </div>
      <div class="small" style="margin-top:8px">Consejo: guarda tus mapeos y preferencias en el navegador.</div>
      <div style="display:flex; gap:8px; margin-top:10px">
        <button class="btn-ghost" id="btnGuardarPrefs">Guardar prefs</button>
        <button class="btn-ghost" id="btnCargarPrefs">Cargar prefs</button>
      </div>
    </div>

  </aside>

  <!-- Map + Table -->
  <section class="panel map-wrap">
    <div class="toolbar">
      <div class="chips">
        <span class="chip" title="Semana 1 a 4 del mes">Semanas</span>
        <span class="chip">Filtros rápidos</span>
      </div>
      <div class="spacer"></div>
      <button class="btn-ghost" id="btnFit">Enfocar RD</button>
      <button class="btn-ghost" id="btnExportCSV">Exportar CSV</button>
      <button class="btn" id="btnExportXLSX">Exportar Excel</button>
    </div>

    <!-- Filtros (editables y combinables) -->
    <div class="section" style="padding:10px 12px; border:1px dashed #e5e7eb; margin:0 12px; border-radius:12px">
      <div class="row" style="grid-template-columns: repeat(5, 1fr); gap:10px">
        <div><label>Vendedores<span class="badge-info" id="vendCount"></span></label><select id="fltVendedor"></select></div>
        <div><label>Empresas</label><select id="fltEmpresa"></select></div>
        <div><label>Provincias</label><select id="fltProvincia"></select></div>
        <div><label>Semanas</label><select id="fltSemana"></select></div>
        <div><label>Días</label><select id="fltDia"></select></div>
      </div>
    </div>

    <div id="map"></div>

    <div class="table">
      <table id="planTable">
        <thead>
          <tr>
            <th>Provincia</th>
            <th>Día</th>
            <th>Semana</th>
            <th>Vendedor</th>
            <th>Gestor</th>
            <th>Empresa</th>
            <th>Razón Social</th>
            <th>Lat</th>
            <th>Lon</th>
            <th>Visitado</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr><td colspan="10" id="tableInfo">0 clientes en el plan.</td></tr>
        </tfoot>
      </table>
    </div>
  </section>
</main>

<footer>
  <div>Planificador de Ruta · RD — <b>v1.1.2</b>. Entrega con filtros, edición en tabla, Excel y diseño responsive para PC.</div>
  <div class="small">Soporta Google Sheets (CSV público) y archivos Excel/CSV locales. El mapa usa <a href="https://leafletjs.com" target="_blank">Leaflet</a>.</div>
</footer>

<script>
/* ---------- Utilidades ---------- */
const $ = (q, root=document) => root.querySelector(q);
const $$ = (q, root=document) => Array.from(root.querySelectorAll(q));
const haversine = (a, b) => {
  const toRad = d => d*Math.PI/180;
  const R = 6371;
  const dLat = toRad(b.lat - a.lat);
  const dLon = toRad(b.lon - a.lon);
  const lat1 = toRad(a.lat), lat2 = toRad(b.lat);
  const hh = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(hh));
};
const clean = v => (v==null ? "" : String(v).trim());

function uniq(arr){ return Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>String(a).localeCompare(String(b),'es')); }
function fillSelect(sel, values, withAll=true, labelAll='(Todos)'){
  sel.innerHTML = '';
  if(withAll){ const o = document.createElement('option'); o.value=''; o.textContent=labelAll; sel.appendChild(o); }
  values.forEach(v => { const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
}

/* ---------- Estado ---------- */
let rawRows = [];      // filas originales (objetos con columnas)
let mappedRows = [];   // filas con nombres estandar
let layerCluster;      // cluster de marcadores
let plan = [];         // plan resultante (asignado)
let filteredPlan = []; // vista filtrada
let vendors = []; let empresas=[]; let provincias=[];

/* ---------- Mapa ---------- */
const map = L.map('map', { zoomControl: true });
const tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap',
  maxZoom: 19
}).addTo(map);
const rdBounds = L.latLngBounds([17.4,-72],[20.1,-68.1]);
map.fitBounds(rdBounds);
layerCluster = L.markerClusterGroup();
map.addLayer(layerCluster);

function fitRD(){
  const v = $('#mapCenter').value.trim();
  if(v && v.includes(',')){
    const [lt, ln] = v.split(',').map(Number);
    if(!Number.isNaN(lt) && !Number.isNaN(ln)){
      map.setView([lt, ln], 7);
      return;
    }
  }
  map.fitBounds(rdBounds);
}
$('#btnFit').addEventListener('click', fitRD);

/* ---------- Carga de datos ---------- */
function headersFromRows(rows){
  const set = new Set();
  rows.forEach(r => Object.keys(r).forEach(k => set.add(k)));
  return Array.from(set);
}
function fillMappingSelectors(headers){
  const targets = [
    'map-provincia','map-dia','map-semana','map-vendedor','map-gestor',
    'map-codempresa','map-empresa','map-razon','map-lat','map-lon'
  ];
  targets.forEach(id => {
    const sel = $('#'+id);
    sel.innerHTML = '<option value="">(no usar)</option>' + headers.map(h=>`<option>${h}</option>`).join('');
  });
}
function tryAutoMap(headers){
  const mapKeys = (name) => {
    const lower = name.toLowerCase();
    const candidates = headers.filter(h => h.toLowerCase()===lower || h.toLowerCase().includes(lower));
    return candidates[0] || "";
  };
  $('#map-provincia').value = mapKeys('provincia');
  $('#map-dia').value = mapKeys('dia');
  $('#map-semana').value = mapKeys('semana');
  $('#map-vendedor').value = mapKeys('vendedor');
  $('#map-gestor').value = mapKeys('gestor_servicio') || mapKeys('gestor');
  $('#map-codempresa').value = mapKeys('cod_empresa') || mapKeys('codigo_empresa');
  $('#map-empresa').value = mapKeys('empresa');
  $('#map-razon').value = mapKeys('razon_social') || mapKeys('razonsocial') || mapKeys('nombre');
  $('#map-lat').value = mapKeys('latitud') || mapKeys('lat');
  $('#map-lon').value = mapKeys('longitud') || mapKeys('lon') || mapKeys('lng');
}
function applyMapping(){
  const m = {
    provincia: $('#map-provincia').value,
    dia: $('#map-dia').value,
    semana: $('#map-semana').value,
    vendedor: $('#map-vendedor').value,
    gestor: $('#map-gestor').value,
    cod_empresa: $('#map-codempresa').value,
    empresa: $('#map-empresa').value,
    razon: $('#map-razon').value,
    lat: $('#map-lat').value,
    lon: $('#map-lon').value,
  };
  mappedRows = rawRows.map((r, idx) => ({
    __id: idx + 1,
    provincia: clean(r[m.provincia]),
    dia: clean(r[m.dia]) || '',
    semana: Number(clean(r[m.semana])) || '',
    vendedor: clean(r[m.vendedor]),
    gestor: clean(r[m.gestor]) || 'NO ASIGNADO',
    cod_empresa: clean(r[m.cod_empresa]),
    empresa: clean(r[m.empresa]),
    razon: clean(r[m.razon]),
    lat: Number(clean(r[m.lat])),
    lon: Number(clean(r[m.lon])),
    visitado: ''
  })).filter(x => !Number.isNaN(x.lat) && !Number.isNaN(x.lon));
  vendors = uniq(mappedRows.map(x=>x.vendedor));
  empresas = uniq(mappedRows.map(x=>x.empresa));
  provincias = uniq(mappedRows.map(x=>x.provincia));
  drawMarkers(mappedRows);
  plan = []; updateFiltersUI(); updateTable([]);
  $('#vendCount').textContent = vendors.length? `${vendors.length}` : '';
}
function updateFiltersUI(){
  fillSelect($('#fltVendedor'), vendors);
  fillSelect($('#fltEmpresa'), empresas);
  fillSelect($('#fltProvincia'), provincias);
  fillSelect($('#fltSemana'), [1,2,3,4].map(String));
  fillSelect($('#fltDia'), ['Lunes','Martes','Miércoles','Jueves','Viernes','Sábado']);
}

/* Google Sheets (CSV público) */
$('#btnLoadGSheet').addEventListener('click', async () => {
  const url = $('#gsheetUrl').value.trim();
  if(!url) return alert('Pega una URL pública de Google Sheets con ?output=csv');
  try{
    const res = await fetch(url);
    const text = await res.text();
    const parsed = Papa.parse(text, { header:true, skipEmptyLines:true });
    rawRows = parsed.data;
    const headers = headersFromRows(rawRows);
    fillMappingSelectors(headers);
    tryAutoMap(headers);
    alert('CSV cargado. Revisa el mapeo y pulsa Aplicar.');
  }catch(e){
    console.error(e);
    alert('No se pudo cargar el CSV. Verifica que sea público.');
  }
});

/* Archivos locales */
$('#fileInput').addEventListener('change', async (ev) => {
  const file = ev.target.files[0];
  if(!file) return;
  const ext = file.name.split('.').pop().toLowerCase();
  if(ext === 'csv'){
    const text = await file.text();
    const parsed = Papa.parse(text, { header:true, skipEmptyLines:true });
    rawRows = parsed.data;
  }else{
    const data = await file.arrayBuffer();
    const wb = XLSX.read(data, { type:'array' });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    rawRows = XLSX.utils.sheet_to_json(sheet, { defval:"" });
  }
  const headers = headersFromRows(rawRows);
  fillMappingSelectors(headers);
  tryAutoMap(headers);
  alert('Archivo cargado. Revisa el mapeo y pulsa Aplicar.');
});

$('#btnAutoMap').addEventListener('click', () => tryAutoMap(headersFromRows(rawRows)));
$('#btnApplyMap').addEventListener('click', applyMapping);

/* ---------- Asignación (Semanas 1–4, Lun–Vie + Sábado opcional) ---------- */
function assignVisits(rows){
  const includeSat = $('#chkSabado').checked;
  const limit = Math.max(1, Number($('#limitPerDay').value) || 8);

  const days = includeSat
    ? ['Lunes','Martes','Miércoles','Jueves','Viernes','Sábado']
    : ['Lunes','Martes','Miércoles','Jueves','Viernes'];

  const weeks = [1,2,3,4];
  const byVendedor = {};
  rows.forEach(r => {
    const key = r.vendedor || 'Sin vendedor';
    (byVendedor[key] ||= []).push(r);
  });

  const result = [];
  for(const [vend, items] of Object.entries(byVendedor)){
    const pool = items.slice();
    const ordered = [];
    if(pool.length){
      let current = pool.shift();
      ordered.push(current);
      while(pool.length){
        let bestIdx = 0, bestDist = Infinity;
        for(let i=0;i<pool.length;i++){
          const d = haversine({lat:current.lat,lon:current.lon},{lat:pool[i].lat,lon:pool[i].lon});
          if(d < bestDist){ bestDist = d; bestIdx = i; }
        }
        current = pool.splice(bestIdx,1)[0];
        ordered.push(current);
      }
    }
    let ptr = 0;
    for(const w of weeks){
      for(const d of days){
        for(let k=0; k<limit && ptr<ordered.length; k++, ptr++){
          const r = ordered[ptr];
          result.push({ ...r, semana:w, dia:d });
        }
      }
    }
    let wIdx = 0, dIdx = 0;
    while(ptr < ordered.length){
      const r = ordered[ptr++];
      result.push({ ...r, semana:weeks[wIdx], dia:days[dIdx] });
      dIdx++; if(dIdx>=days.length){ dIdx=0; wIdx=(wIdx+1)%weeks.length; }
    }
  }
  return result;
}
$('#btnProcesar').addEventListener('click', () => {
  if(!mappedRows.length) return alert('Primero carga datos y aplica el mapeo.');
  plan = assignVisits(mappedRows).map((r,i)=>({...r, __id: r.__id || (i+1), visitado: r.visitado || ''}));
  vendors = uniq(plan.map(x=>x.vendedor)); $('#vendCount').textContent = vendors.length? `${vendors.length}` : '';
  updateFiltersUI();
  applyFiltersAndRender();
  alert('Plan generado. Puedes editar Día/Semana/Vendedor en la tabla y filtrar arriba.');
});
$('#btnLimpiar').addEventListener('click', () => {
  plan = []; mappedRows = []; rawRows = []; filteredPlan=[];
  layerCluster.clearLayers();
  $('#planTable tbody').innerHTML = '';
  $('#tableInfo').textContent = '0 clientes en el plan.';
  alert('Se limpió la vista. Vuelve a cargar datos.');
});

/* ---------- Filtros ---------- */
const filterState = { vendedor:'', empresa:'', provincia:'', semana:'', dia:'' };
['fltVendedor','fltEmpresa','fltProvincia','fltSemana','fltDia'].forEach(id=>{
  $('#'+id).addEventListener('change', ()=>{
    filterState.vendedor = $('#fltVendedor').value;
    filterState.empresa  = $('#fltEmpresa').value;
    filterState.provincia= $('#fltProvincia').value;
    filterState.semana   = $('#fltSemana').value;
    filterState.dia      = $('#fltDia').value;
    applyFiltersAndRender();
  });
});
$('#searchBox').addEventListener('input', ()=>applyFiltersAndRender());

function applyFiltersAndRender(){
  const q = $('#searchBox').value.trim().toLowerCase();
  filteredPlan = plan.filter(r => {
    if(filterState.vendedor && r.vendedor !== filterState.vendedor) return false;
    if(filterState.empresa && r.empresa !== filterState.empresa) return false;
    if(filterState.provincia && r.provincia !== filterState.provincia) return false;
    if(filterState.semana && String(r.semana) !== String(filterState.semana)) return false;
    if(filterState.dia && r.dia !== filterState.dia) return false;
    if(q){
      const hay = [r.razon, r.vendedor, r.gestor, r.empresa].join(' ').toLowerCase();
      if(!hay.includes(q)) return false;
    }
    return true;
  });
  updateTable(filteredPlan);
  drawMarkers(filteredPlan);
}

/* ---------- Render de mapa y tabla ---------- */
function drawMarkers(rows){
  layerCluster.clearLayers();
  const markers = rows.map(r => {
    const mk = L.marker([r.lat, r.lon]);
    const html = `
      <b>${(r.razon || '(Sin nombre)')}</b><br>
      <span class="small">${[r.empresa, r.provincia].filter(Boolean).join(' · ')}</span><br>
      <span class="small">Vendedor: ${r.vendedor || '-'}</span><br>
      <span class="small">Día/Sem: ${r.dia || '-'} / ${r.semana || '-'}</span>
    `;
    mk.bindPopup(html);
    return mk;
  });
  markers.forEach(m => layerCluster.addLayer(m));
  if(markers.length){
    const g = L.featureGroup(markers);
    map.fitBounds(g.getBounds().pad(0.2));
  }else{
    fitRD();
  }
}

function updateTable(rows){
  const tb = $('#planTable tbody');
  const days = ['Lunes','Martes','Miércoles','Jueves','Viernes','Sábado'];
  const vendOptions = vendors.map(v=>`<option value="${v}">${v}</option>`).join('');
  tb.innerHTML = rows.map((r,idx) => `
    <tr data-id="${r.__id}">
      <td>${r.provincia||''}</td>
      <td>
        <select class="edit-dia">
          ${days.map(d => `<option value="${d}" ${r.dia===d?'selected':''}>${d}</option>`).join('')}
        </select>
      </td>
      <td>
        <select class="edit-semana">
          ${[1,2,3,4].map(w => `<option value="${w}" ${String(r.semana)===String(w)?'selected':''}>${w}</option>`).join('')}
        </select>
      </td>
      <td>
        <select class="edit-vendedor">
          <option value="">Sin vendedor</option>
          ${vendOptions.replace(`value="${r.vendedor}"`, `value="${r.vendedor}" selected`)}
        </select>
      </td>
      <td>${r.gestor||''}</td>
      <td>${r.empresa||''}</td>
      <td>${r.razon||''}</td>
      <td>${Number.isFinite(r.lat)?r.lat.toFixed(6):''}</td>
      <td>${Number.isFinite(r.lon)?r.lon.toFixed(6):''}</td>
      <td style="text-align:center"><input type="checkbox" class="edit-visitado" ${r.visitado?'checked':''} /></td>
    </tr>
  `).join('');
  $('#tableInfo').textContent = `${rows.length} clientes en el plan (filtrado).`;

  // Listeners de edición
  $$('#planTable .edit-dia').forEach(sel => sel.addEventListener('change', onEditChange));
  $$('#planTable .edit-semana').forEach(sel => sel.addEventListener('change', onEditChange));
  $$('#planTable .edit-vendedor').forEach(sel => sel.addEventListener('change', onEditChange));
  $$('#planTable .edit-visitado').forEach(chk => chk.addEventListener('change', onEditChange));
}

function onEditChange(ev){
  const tr = ev.target.closest('tr');
  const id = Number(tr.dataset.id);
  const row = plan.find(x => x.__id === id);
  if(!row) return;
  if(ev.target.classList.contains('edit-dia')) row.dia = ev.target.value;
  if(ev.target.classList.contains('edit-semana')) row.semana = Number(ev.target.value);
  if(ev.target.classList.contains('edit-vendedor')) row.vendedor = ev.target.value;
  if(ev.target.classList.contains('edit-visitado')) row.visitado = ev.target.checked ? 'Sí' : '';
  applyFiltersAndRender(); // actualiza mapa y tabla
}

/* ---------- Exportar ---------- */
$('#btnExportCSV').addEventListener('click', () => {
  const rows = (filteredPlan.length?filteredPlan:plan);
  if(!rows.length) return alert('No hay plan para exportar.');
  const arr = [
    ['Provincia','Día','Semana','Vendedor','Gestor','Empresa','Razón Social','Lat','Lon','Visitado'],
    ...rows.map(r => [r.provincia||'', r.dia||'', r.semana||'', r.vendedor||'', r.gestor||'', r.empresa||'', r.razon||'', r.lat||'', r.lon||'', r.visitado||''])
  ];
  const csv = arr.map(r => r.map(v => `"${String(v).replaceAll('"','""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'plan_visitas_v1.1.2.csv';
  document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 200);
});

$('#btnExportXLSX').addEventListener('click', () => {
  const rows = (filteredPlan.length?filteredPlan:plan);
  if(!rows.length) return alert('No hay plan para exportar.');
  const data = rows.map(r => ({
    Provincia: r.provincia||'',
    Día: r.dia||'',
    Semana: r.semana||'',
    Vendedor: r.vendedor||'',
    Gestor: r.gestor||'',
    Empresa: r.empresa||'',
    'Razón Social': r.razon||'',
    Lat: r.lat||'',
    Lon: r.lon||'',
    Visitado: r.visitado||''
  }));
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(data);
  XLSX.utils.book_append_sheet(wb, ws, 'Ruta');
  XLSX.writeFile(wb, 'plan_visitas_v1.1.2.xlsx');
});

/* ---------- Preferencias ---------- */
$('#btnGuardarPrefs').addEventListener('click', () => {
  const prefs = {
    mapCenter: $('#mapCenter').value,
    mode: $('#mode').value,
    limit: $('#limitPerDay').value,
    sabado: $('#chkSabado').checked,
    mapping: {
      provincia: $('#map-provincia').value,
      dia: $('#map-dia').value,
      semana: $('#map-semana').value,
      vendedor: $('#map-vendedor').value,
      gestor: $('#map-gestor').value,
      cod_empresa: $('#map-codempresa').value,
      empresa: $('#map-empresa').value,
      razon: $('#map-razon').value,
      lat: $('#map-lat').value,
      lon: $('#map-lon').value,
    }
  };
  localStorage.setItem('planner_prefs', JSON.stringify(prefs));
  alert('Preferencias guardadas.');
});

$('#btnCargarPrefs').addEventListener('click', () => {
  const raw = localStorage.getItem('planner_prefs');
  if(!raw) return alert('No hay preferencias guardadas.');
  const p = JSON.parse(raw);
  $('#mapCenter').value = p.mapCenter || $('#mapCenter').value;
  $('#mode').value = p.mode || $('#mode').value;
  $('#limitPerDay').value = p.limit || $('#limitPerDay').value;
  $('#chkSabado').checked = !!p.sabado;
  alert('Preferencias cargadas. Si ya tienes datos, revisa el mapeo y pulsa Aplicar.');
});
</script>
</body>
</html>
