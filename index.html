<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Planificador de rutas para vendedores</title>
  <!-- Hoja de estilos de Leaflet para el mapa -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    integrity="sha512-xodZBNTC5n17Xt2vOT+qsA7cmiwDgQzvms5H5tBpF5gR2D4l/s1pPv6VqGexi3DG1Jr05S8u7lAt1aPLPcw3g=="
    crossorigin=""
  />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      background-color: #0a6c9b;
      color: white;
      padding: 10px 20px;
      text-align: center;
    }
    main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    /* Panel izquierdo para carga de datos y opciones */
    #sidebar {
      width: 350px;
      min-width: 300px;
      max-width: 400px;
      background-color: #f4f4f4;
      padding: 10px;
      overflow-y: auto;
      border-right: 1px solid #ccc;
    }
    #sidebar h2 {
      margin-top: 0;
    }
    #controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 10px;
    }
    #controls select, #controls input[type="file"] {
      padding: 5px;
      font-size: 14px;
    }
    #assignBtn, #exportBtn, #clearRouteBtn {
      padding: 8px;
      font-size: 14px;
      margin-top: 5px;
      background-color: #0a6c9b;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    #assignBtn:hover, #exportBtn:hover, #clearRouteBtn:hover {
      background-color: #084c6f;
    }
    #tableContainer {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ccc;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    th, td {
      padding: 4px;
      border: 1px solid #ccc;
      text-align: left;
    }
    th {
      background-color: #e0e0e0;
    }
    #map {
      flex: 1;
    }
    #routeSummary {
      margin-top: 10px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Planificador de rutas para vendedores</h1>
    <p>Cargue un archivo Excel y genere rutas de lunes a viernes, semana 1 a 4</p>
  </header>
  <main>
    <div id="sidebar">
      <h2>1. Cargar datos</h2>
      <div id="controls">
        <input type="file" id="fileInput" accept=".xlsx,.xls" />
        <select id="vendorSelect">
          <option value="">-- Seleccione vendedor --</option>
        </select>
        <select id="weekSelect">
          <option value="">-- Semana --</option>
          <option value="1">Semana 1</option>
          <option value="2">Semana 2</option>
          <option value="3">Semana 3</option>
          <option value="4">Semana 4</option>
        </select>
        <select id="daySelect">
          <option value="">-- Día --</option>
          <option value="Lunes">Lunes</option>
          <option value="Martes">Martes</option>
          <option value="Miércoles">Miércoles</option>
          <option value="Jueves">Jueves</option>
          <option value="Viernes">Viernes</option>
        </select>
        <button id="assignBtn" disabled>Asignar a ruta</button>
        <button id="clearRouteBtn" disabled>Limpiar ruta</button>
        <button id="exportBtn" disabled>Exportar CSV</button>
      </div>
      <h2>2. Seleccionar direcciones</h2>
      <div id="tableContainer">
        <!-- La tabla con las filas del Excel se insertará aquí -->
      </div>
      <div id="routeSummary"></div>
    </div>
    <div id="map"></div>
  </main>

  <!-- Librerías externas -->
  <script
    src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
    integrity="sha512-nNMjbH+K1L3xPqF4pJh5MCvZvj1YZ5ZgYGilrB5E8iFw6jue6R/z8k4+c5p0YiPpC9JZwBf4dr7z5zUa1BcQ8g=="
    crossorigin=""
  ></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.17.0/dist/xlsx.full.min.js"></script>
  <script>
    // Variables globales
    let rawData = [];
    let currentRoute = [];
    let map, routeLayer;

    // Inicializar mapa
    function initMap() {
      map = L.map('map').setView([18.5, -70.0], 8);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);
    }

    // Leer y procesar archivo Excel
    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(evt) {
        const data = new Uint8Array(evt.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        rawData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });
        populateVendorSelect(rawData);
        populateTable(rawData);
      };
      reader.readAsArrayBuffer(file);
    }

    // Poblar el select de vendedores
    function populateVendorSelect(data) {
      const vendorSelect = document.getElementById('vendorSelect');
      // Limpiar opciones previas
      vendorSelect.innerHTML = '<option value="">-- Seleccione vendedor --</option>';
      const vendors = Array.from(new Set(data.map(item => item.vendedor).filter(Boolean)));
      vendors.forEach(v => {
        const option = document.createElement('option');
        option.value = v;
        option.textContent = v;
        vendorSelect.appendChild(option);
      });
    }

    // Crear tabla con datos
    function populateTable(data) {
      const container = document.getElementById('tableContainer');
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      const headers = ['Selec', 'Empresa', 'Cod Empresa', 'Razón Social', 'Provincia', 'Vendedor', 'Lat', 'Lon'];
      headers.forEach(h => {
        const th = document.createElement('th');
        th.textContent = h;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);
      const tbody = document.createElement('tbody');
      data.forEach((row, idx) => {
        const tr = document.createElement('tr');
        // Checkbox
        const tdCheck = document.createElement('td');
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.dataset.index = idx; // mantener referencia al índice en rawData
        tdCheck.appendChild(cb);
        tr.appendChild(tdCheck);
        // Empresa
        const tdEmpresa = document.createElement('td');
        tdEmpresa.textContent = row.Empresa || '';
        tr.appendChild(tdEmpresa);
        // Cod Empresa
        const tdCodigo = document.createElement('td');
        tdCodigo.textContent = row['Cod Empresa'] || '';
        tr.appendChild(tdCodigo);
        // Razon Social
        const tdRazon = document.createElement('td');
        tdRazon.textContent = row.RazonSocial || '';
        tr.appendChild(tdRazon);
        // Provincia
        const tdProv = document.createElement('td');
        tdProv.textContent = row.provincia || '';
        tr.appendChild(tdProv);
        // Vendedor
        const tdVend = document.createElement('td');
        tdVend.textContent = row.vendedor || '';
        tr.appendChild(tdVend);
        // Latitud
        const tdLat = document.createElement('td');
        tdLat.textContent = row.latitud || '';
        tr.appendChild(tdLat);
        // Longitud
        const tdLon = document.createElement('td');
        tdLon.textContent = row.longitud || '';
        tr.appendChild(tdLon);
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      container.innerHTML = '';
      container.appendChild(table);
      // Habilitar botón asignar al cargar la tabla
      document.getElementById('assignBtn').disabled = false;
      document.getElementById('clearRouteBtn').disabled = false;
    }

    // Haversine formula para distancia entre dos puntos geográficos
    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371; // radio de la Tierra en km
      const toRad = deg => deg * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // Generar ruta usando algoritmo de vecino más cercano
    function generateRoute(selected) {
      if (selected.length === 0) return [];
      // Copiar array y convertir lat/lon a números
      const points = selected.map(item => ({
        index: item.index,
        lat: parseFloat(item.row.latitud),
        lon: parseFloat(item.row.longitud),
        data: item.row
      }));
      const route = [];
      // Iniciar con el primer punto
      let current = points.shift();
      route.push(current);
      while (points.length > 0) {
        // Buscar el más cercano al actual
        let nearestIndex = 0;
        let nearestDist = Infinity;
        for (let i = 0; i < points.length; i++) {
          const dist = haversine(current.lat, current.lon, points[i].lat, points[i].lon);
          if (dist < nearestDist) {
            nearestDist = dist;
            nearestIndex = i;
          }
        }
        current = points.splice(nearestIndex, 1)[0];
        route.push(current);
      }
      return route;
    }

    // Mostrar ruta en el mapa y resumen
    function displayRoute(route) {
      if (routeLayer) {
        map.removeLayer(routeLayer);
      }
      const latlngs = route.map(p => [p.lat, p.lon]);
      // Dibujar líneas y marcadores
      routeLayer = L.layerGroup();
      // Crear polyline
      const polyline = L.polyline(latlngs, { color: 'blue' });
      routeLayer.addLayer(polyline);
      // Crear marcadores con etiquetas
      route.forEach((p, idx) => {
        const marker = L.marker([p.lat, p.lon], {
          title: (idx + 1) + '. ' + (p.data.RazonSocial || p.data.Empresa || '')
        });
        marker.bindPopup('<strong>' + (idx + 1) + '.</strong> ' +
          (p.data.RazonSocial || p.data.Empresa || '') + '<br/>' +
          'Vendedor: ' + (p.data.vendedor || '') + '<br/>' +
          'Provincia: ' + (p.data.provincia || ''));
        routeLayer.addLayer(marker);
      });
      routeLayer.addTo(map);
      // Ajustar vista
      if (latlngs.length > 0) {
        map.fitBounds(L.latLngBounds(latlngs));
      }
      // Mostrar resumen con distancias
      let totalDistance = 0;
      for (let i = 0; i < route.length - 1; i++) {
        totalDistance += haversine(
          route[i].lat, route[i].lon, route[i + 1].lat, route[i + 1].lon
        );
      }
      const summary = document.getElementById('routeSummary');
      summary.innerHTML = '<strong>Paradas:</strong> ' + route.length + '<br>' +
        '<strong>Distancia aproximada:</strong> ' + totalDistance.toFixed(2) + ' km';
      // Habilitar exportar
      document.getElementById('exportBtn').disabled = false;
    }

    // Generar CSV para exportar
    function exportCSV(route, vendor, week, day) {
      const header = ['Orden', 'Vendedor', 'Semana', 'Día', 'Empresa', 'Cod Empresa', 'Razón Social', 'Provincia', 'Lat', 'Lon'];
      const rows = [header];
      route.forEach((p, idx) => {
        const r = p.data;
        rows.push([
          idx + 1,
          vendor,
          week,
          day,
          r.Empresa || '',
          r['Cod Empresa'] || '',
          r.RazonSocial || '',
          r.provincia || '',
          r.latitud || '',
          r.longitud || ''
        ]);
      });
      const csvContent = rows.map(e => e.join(',')).join('\n');
      return csvContent;
    }

    // Manejar clic en Asignar ruta
    function handleAssign() {
      // Obtener selección de vendedor, semana y día
      const vendor = document.getElementById('vendorSelect').value;
      const week = document.getElementById('weekSelect').value;
      const day = document.getElementById('daySelect').value;
      if (!vendor || !week || !day) {
        alert('Seleccione vendedor, semana y día antes de asignar.');
        return;
      }
      // Obtener filas seleccionadas
      const checkboxes = document.querySelectorAll('#tableContainer input[type="checkbox"]:checked');
      if (checkboxes.length === 0) {
        alert('Seleccione al menos una dirección.');
        return;
      }
      const selected = [];
      checkboxes.forEach(cb => {
        const idx = parseInt(cb.dataset.index, 10);
        selected.push({ index: idx, row: rawData[idx] });
      });
      // Filtrar solo las filas del vendedor seleccionado
      const filtered = selected.filter(item => item.row.vendedor === vendor);
      if (filtered.length === 0) {
        alert('Las direcciones seleccionadas no corresponden al vendedor elegido.');
        return;
      }
      // Generar ruta
      currentRoute = generateRoute(filtered);
      displayRoute(currentRoute);
      // Preparar exportación CSV
      document.getElementById('exportBtn').onclick = () => {
        const csv = exportCSV(currentRoute, vendor, week, day);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `ruta_${vendor}_sem${week}_${day}.csv`;
        link.click();
        URL.revokeObjectURL(url);
      };
    }

    // Limpiar ruta y resumen
    function clearRoute() {
      if (routeLayer) {
        map.removeLayer(routeLayer);
        routeLayer = null;
      }
      currentRoute = [];
      document.getElementById('routeSummary').innerHTML = '';
      document.getElementById('exportBtn').disabled = true;
    }

    // Eventos y inicialización
    document.addEventListener('DOMContentLoaded', () => {
      initMap();
      document.getElementById('fileInput').addEventListener('change', handleFile);
      document.getElementById('assignBtn').addEventListener('click', handleAssign);
      document.getElementById('clearRouteBtn').addEventListener('click', clearRoute);
    });
  </script>
</body>
</html>